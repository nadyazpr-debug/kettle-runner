name: Jalankan ETL Pentaho dan Simpan Hasil

on:
  workflow_dispatch:

# 1. PENTING: Berikan izin menulis (Write) ke token GITHUB_TOKEN
permissions:
  contents: write

jobs:
  execute-etl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Java JDK 11
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "11"

      - name: Install Pentaho Data Integration
        run: |
          wget --no-check-certificate --progress=dot:giga "https://archive.apache.org/dist/hop/2.9.0/apache-hop-client-2.9.0.zip" -O pdi.zip || \
          curl -L "https://github.com/pentaho/pentaho-kettle/releases/download/9.4.0.0-343/pdi-ce-9.4.0.0-343.zip" -o pdi.zip || \
          curl -L "https://iweb.dl.sourceforge.net/project/pentaho/Data%20Integration/9.4/pdi-ce-9.4.0.0-343.zip" -o pdi.zip
          unzip -q pdi.zip
          chmod +x data-integration/kitchen.sh

      # 2. Jalankan Job (Pastikan output diarahkan ke folder repo)
      - name: Run ETL Job
        run: |
          # Pastikan Pentaho menyimpan output ke ${GITHUB_WORKSPACE}/output/
          ./data-integration/kitchen.sh -file="${GITHUB_WORKSPACE}/etl/job_json_to_excel.kjb" -level=Basic

      # 3. BARU: Commit dan Push Hasil ke Repo
      - name: Commit and Push Result
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          # Tambahkan semua file baru (misal hasil csv/json)
          git add .

          # Commit hanya jika ada perubahan
          # (Mencegah error jika script dijalankan tapi tidak ada file baru)
          git commit -m "Auto-generated: Update Laporan ETL [skip ci]" || echo "Tidak ada perubahan data"

          # Push kembali ke branch main
          git push
